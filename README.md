# mahjong16-go

以 Go 語言實作的**十六張麻將**模擬器，包含四人自動對局與簡易 AI 決策邏輯。

## 功能

- 完整牌組（144 張）：餅（筒）、索（條）、萬、風牌（東南西北）、三元牌（中發白）、花牌（春夏秋冬梅蘭竹菊）
- 四人自動對局，輪流摸牌、打牌
- 自動補花（摸到花牌後補抽一張）
- 聽牌計算：列出打出每張牌後可等待的胡牌
- 胡牌判定：支援標準麻將胡牌型（眼＋順子／刻子）
- 簡易 AI：優先打出能讓聽牌數最多的牌

## 執行方式

需先安裝 [Go](https://go.dev/)（1.21 以上版本）。

```bash
go run .      # 執行（全 AI 自動對局）
go build .    # 編譯為執行檔
```

## 程式架構

原始碼分成四個職責明確的檔案：

| 檔案 | 職責 |
|------|------|
| [server.go](server.go) | `Server` 型別定義、`NewServer()`、`nToChinese()` 牌號顯示 |
| [random.go](random.go) | 所有隨機性操作：洗牌、發牌、補花、隨機打牌索引 |
| [AI.go](AI.go) | AI 決策、聽牌計算、胡牌判定演算法 |
| [client.go](client.go) | `Player` 型別、打牌邏輯（手動／AI）、主遊戲迴圈 |

### 型別

| 型別 | 所在檔案 | 說明 |
|------|----------|------|
| `Server` | [server.go](server.go) | 遊戲伺服器：手牌張數、剩餘牌堆、海底 |
| `Player` | [client.go](client.go) | 玩家狀態：手牌、桌面牌（花）、已見牌統計、打牌機率、聽牌清單 |

### 手動打牌

若想讓某位玩家改為手動操作，將 [client.go](client.go) 主迴圈中對應的

```go
n := p.playAI(s)
```

替換為：

```go
n := p.playManual(s)
```

### 牌號編碼

牌號為 0～151 的整數，每種牌面有 4 張（index `n`，牌面 `n/4`）：

| 範圍 | 牌種 |
|------|------|
| 0 – 35 | 1～9 筒（餅） |
| 36 – 71 | 1～9 條（索） |
| 72 – 107 | 1～9 萬 |
| 108 – 123 | 東南西北（風牌） |
| 124 – 135 | 中發白（三元牌） |
| 136 – 143 | 春夏秋冬梅蘭竹菊（花牌） |

### 主要函式

| 函式 | 檔案 | 說明 |
|------|------|------|
| `NewServer(nHand)` | [server.go](server.go) | 建立遊戲伺服器，呼叫 `Shuffle()` 初始化牌堆 |
| `nToChinese(n)` | [server.go](server.go) | 將牌號轉為中文名稱（如 `"3筒"`、`"東"`） |
| `Shuffle()` | [random.go](random.go) | 回傳 144 張牌的隨機排列 |
| `initDeal(players)` | [random.go](random.go) | 發初始手牌（每人 16 張） |
| `showBonus(players)` | [random.go](random.go) | 開局補花，並初始化各玩家的已見牌記錄 |
| `iShowBonus(p, i)` | [random.go](random.go) | 對第 `i` 張手牌遞迴補花 |
| `deal1()` | [random.go](random.go) | 從牌堆頂抽 1 張牌 |
| `RandomPlay(nHand)` | [random.go](random.go) | 回傳隨機打牌索引（AI 後備策略） |
| `decidePlay(p)` | [AI.go](AI.go) | AI 決策：優先打後聽牌最多，次選最常出現的牌 |
| `gates(p)` | [AI.go](AI.go) | 計算打出每張牌後的聽牌清單（`map[牌面]聽牌數`） |
| `isWin(p)` | [AI.go](AI.go) | 判斷玩家是否胡牌 |
| `isSuit(suited)` | [AI.go](AI.go) | 判斷數牌部分是否合法（遞迴，採定理一） |
| `isHonor(honor)` | [AI.go](AI.go) | 判斷字牌部分是否合法（每種字牌須為 0 或 3 張） |
| `sortHand(tiles)` | [AI.go](AI.go) | 複製手牌陣列並排序 |
| `findPair(sorted, pairs)` | [AI.go](AI.go) | 找出手牌中所有可能的「眼」位置（採定理二） |
| `initSee()` / `addSee(t)` | [client.go](client.go) | 更新玩家已見過的牌 |
| `play(n, hand)` | [client.go](client.go) | 打出第 `n` 張，換入摸到的牌 |
| `playAI(s)` | [client.go](client.go) | 呼叫 AI.go 自動選牌 |
| `playManual(s)` | [client.go](client.go) | 顯示手牌並讓使用者輸入選擇 |

### AI 決策邏輯（`decidePlay`）

1. 從 `gates` 結果中找出打後聽牌數最多的牌，優先打出。
2. 若無聽牌，打出出現次數（`cPlay`）最少（即最稀有）的牌。
3. 若仍無法決定，隨機選牌。

## 輸出格式範例

```
0 1筒 3筒 ...（開局手牌及補花）

0摸 5條 打後聽牌: 2萬=3 東=1
0打 5條_ 1筒 3筒 5筒 ...
1摸 中 ...
...
2胡 1筒 3筒 5筒 ...
```

- `補 X`：補花後摸到的牌
- `打後聽牌: 牌=數`：打出某牌後，有幾張可胡的牌在牌堆中
- `X打 Y_`：X 玩家打出 Y 牌，`_` 後為剩餘手牌
- `|X`：桌面花牌

## 胡牌判定原理

本章深入說明 `isWin`、`isSuit`、`isHonor`、`findPair` 及 `findSuitPair` 的數學基礎，主要參考學術論文 *Mathematical aspects of the combinatorial game "Mahjong"*（Cheng, Li & Li，arXiv:1707.07345）。

### 基本胡牌型式

十六張麻將的合法胡牌由 **17 張牌**組成（16 張手牌加上剛摸入的牌），結構固定為：

- **1 對眼**：相同牌面的 2 張
- **5 組面子**：每組 3 張，可為**刻子**（同牌面 3 張）或**順子**（同花色連續 3 張，僅限數牌）

字牌（風牌、三元牌）因無連續關係，只能組成刻子。

### `isWin` 的整體流程

1. 將全部 17 張手牌排序。
2. 呼叫 `findPair` 找出所有候選眼的位置，同時統計數牌各點數的出現次數（`suited`）與字牌各種類的出現次數（`honor`）。
3. 對每個候選眼，暫時從統計陣列中扣除 2 張，再以 `isHonor` 驗證字牌、以 `isSuit` 驗證數牌。
4. 兩者皆通過即立刻回傳 `true`；全部候選均不合法則回傳 `false`。

### 定理一：數牌合法性（`isSuit`）

`isSuit` 對應論文中的**命題 4.2**：

> **若當前最小點數的牌出現 3 張（含）以上，必可將其視為一組刻子，而不影響剩餘牌能否分解成合法面子的結論。**

這個命題保證了貪婪策略的正確性：程式依花色從最小點數向右逐一掃描，遇到計數 ≥ 3 時直接扣除 3 張（刻子），否則嘗試與後兩個點數各扣 1 張（順子）。若任一步驟無法滿足，立即返回失敗；若三個花色（筒、條、萬）的計數全部歸零，則判定合法。此遞迴演算法不需枚舉所有拆牌方式，效率遠優於暴力搜尋。

### 定理二：快速定位眼（`findSuitPair`）

對 17 張手牌中的每一張都嘗試作為眼，代價過高。`findSuitPair` 利用**模 3 餘數**快速縮小範圍，其數學根據如下：

將一個花色的所有牌依點數對 3 取餘分成三組（餘數為 0、1、2）。考慮面子對各組計數的影響：

- **刻子**（同點數 3 張）：使某組計數 +3，三組的模 3 餘數皆不變。
- **順子**（連續 3 張）：三組各 +1，三組餘數同步改變，差值保持不變。
- **眼**（同點數 2 張）：使某組計數 +2，**該組餘數與另外兩組產生差異**。

因此，在拿掉所有面子後，三組中「模 3 餘數與另外兩組不同的那一組」，必然就是眼所在的組。程式只需在這一組內枚舉配對候選，大幅減少不必要的試算。字牌部分由 `findHonorPair` 處理，因字牌種類互不相連，直接對每種字牌逐一嘗試配對即可。

### 字牌合法性（`isHonor`）

去掉眼之後，字牌只能以刻子型式存在。`isHonor` 對 7 種字牌（東南西北、中發白）逐一檢查：每種字牌的剩餘數量必須為 **0 或 3**，否則直接判定失敗。由於邏輯單純，此函式僅需一次線性掃描，是整個判定流程中最輕量的一環。

### 十六張與十三張的差異

標準十三張麻將（14 張含摸入）胡牌型為 1 對眼 ＋ 4 組面子，而台灣十六張麻將多出一組面子：

| 規則 | 含摸入總張數 | 面子數 | 眼 |
|------|------------|-------|----|
| 標準十三張 | 14 | 4 組 | 1 對 |
| 台灣十六張 | 17 | 5 組 | 1 對 |

論文亦指出，對十六張規則而言，九門摸牌（可胡所有 9 種同花色點數的手牌）不再唯一，共存在 **11 種**不同形態，遠比十三張的唯一九門更為豐富。

## 限制與注意事項

- 本程式為純自動對局（無使用者互動）
- 不支援吃、碰、槓
- 不計算番數或積分
- 每次執行結果隨機（使用 `math/rand` 預設亂數種子）
